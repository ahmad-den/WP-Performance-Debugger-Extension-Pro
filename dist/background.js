(()=>{"use strict";var t={662:(t,e,a)=>{a.r(e),a.d(e,{cleanupPSIResults:()=>l,cleanupTab:()=>u,getPSIResults:()=>c,getTabResults:()=>o,storePSIResults:()=>s,storeTabResults:()=>i});const n=new Map,r=new Map;function i(t,e){n.set(t,e)}function o(t){return n.get(t)||null}function s(t,e){r.set(t,e)}function c(t){return r.get(t)||null}function l(t){r.delete(t)}function u(t){n.delete(t),l(t)}}},e={};function a(n){var r=e[n];if(void 0!==r)return r.exports;var i=e[n]={exports:{}};return t[n](i,i.exports,a),i.exports}a.d=(t,e)=>{for(var n in e)a.o(e,n)&&!a.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},a.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),a.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var n=a(662);const r=new Map;function i(t,e){try{const a=new URL(t);return a.searchParams.forEach((t,n)=>{e.has(n)||a.searchParams.delete(n)}),e.forEach(t=>{a.searchParams.set(t,"")}),a.toString()}catch(a){return t}}function o(t){try{const e=new URL(t);return new Set(e.searchParams.keys())}catch(e){return new Set}}function s(t){return r.get(t)||new Set}function c(t,e){let a=r.get(t);return a||(a=new Set,r.set(t,a)),!a.has(e)&&(a.add(e),!0)}function l(t,e){const a=r.get(t);return!(!a||!a.has(e))&&(a.delete(e),!0)}function u(t,e){e.tabs.get(t,a=>{if(e.runtime.lastError)return;const n=s(t),r=o(a.url),c=i(a.url,n);var l,u;c===a.url||(u=r,(l=n).size===u.size&&[...l].every(t=>u.has(t)))||e.tabs.update(t,{url:c})})}const d="attached",h="detached",f="popup_window_state",w="detached_window_id",g="detached_window_bounds",p=700,b=600,m=globalThis.chrome||self.chrome;async function y(){try{return(await m.storage.local.get(f))[f]||d}catch(t){return d}}async function I(t){try{await m.storage.local.set({[f]:t})}catch(e){}}async function P(){try{return(await m.storage.local.get(w))[w]||null}catch(t){return null}}async function v(t){try{null===t?await m.storage.local.remove(w):await m.storage.local.set({[w]:t})}catch(e){}}async function S(t){try{null===t?await m.storage.local.remove(g):t&&"object"==typeof t&&t.width>=300&&t.height>=200&&t.width<=2e3&&t.height<=1500&&"number"==typeof t.left&&"number"==typeof t.top&&await m.storage.local.set({[g]:t})}catch(e){}}async function R(t){try{null===t?await m.storage.local.remove("originalTabId"):await m.storage.local.set({originalTabId:t})}catch(e){}}const L=globalThis.chrome||self.chrome;let D=null;async function T(t){try{const e=await async function(){try{const t=(await m.storage.local.get(g))[g];return t&&"object"==typeof t?t.width>=300&&t.height>=200&&t.width<=2e3&&t.height<=1500&&"number"==typeof t.left&&"number"==typeof t.top?t:(await S(null),null):null}catch(t){return null}}()||{left:100,top:100,width:p,height:b},a=await async function(t){try{const e=await new Promise(t=>{L.system&&L.system.display?L.system.display.getInfo(e=>{L.runtime.lastError?t([]):t(e||[])}):t([])});if(!e||0===e.length)return{left:100,top:100,width:Math.min(t.width||p,1200),height:Math.min(t.height||b,800)};const a=(e.find(t=>t.isPrimary)||e[0]).bounds,n=Math.min(t.width||p,a.width-100),r=Math.min(t.height||b,a.height-100),i=a.left-Math.floor(.5*n),o=a.left+a.width-Math.floor(.5*n),s=a.top-Math.floor(.5*r),c=a.top+a.height-Math.floor(.5*r);let l=t.left||100,u=t.top||100;return l=Math.max(i,Math.min(o,l)),u=Math.max(s,Math.min(c,u)),l+n<a.left+100&&(l=a.left+100),u+r<a.top+100&&(u=a.top+100),{left:l,top:u,width:n,height:r}}catch(e){return{left:100,top:100,width:Math.min(t.width||p,1e3),height:Math.min(t.height||b,700)}}}(e),n={url:t?`${L.runtime.getURL("popup.html")}?originalTabId=${t}`:L.runtime.getURL("popup.html"),type:"popup",focused:!0,...a},r=await L.windows.create(n);return D=r,await v(r.id),await I(h),t&&await R(t),r}catch(e){try{const e={url:t?`${L.runtime.getURL("popup.html")}?originalTabId=${t}`:L.runtime.getURL("popup.html"),type:"popup",focused:!0,left:100,top:100,width:600,height:500},a=await L.windows.create(e);return D=a,await v(a.id),await I(h),t&&await R(t),a}catch(a){throw a}}}async function M(){D=null,await v(null),await I(d)}async function C(t){try{const e=await L.windows.get(t);if(e.left>=-1e3&&e.top>=-1e3&&e.width>=300&&e.height>=200&&e.width<=2e3&&e.height<=1500){const t={left:e.left,top:e.top,width:e.width,height:e.height};await S(t)}}catch(e){}}async function U(t){return await P()===t}const B=new Map,E=globalThis.chrome||self.chrome;function _(t,e,n){var r;const i=null===(r=e.tab)||void 0===r?void 0:r.id;i&&t.fieldData&&Promise.resolve().then(a.bind(a,662)).then(({getPSIResults:e,storePSIResults:a})=>{const r=e(i)||{allFieldData:{},allLabData:{}};r.allFieldData||(r.allFieldData={}),r.allFieldData[n]=t.fieldData,a(i,r)}),N(t),t.fieldData}function x(t,e,n){var r;const i=null===(r=e.tab)||void 0===r?void 0:r.id;i&&t.labData&&Promise.resolve().then(a.bind(a,662)).then(({getPSIResults:e,storePSIResults:a})=>{const r=e(i)||{allFieldData:{},allLabData:{}};r.allLabData||(r.allLabData={}),r.allLabData[`lab${n.toUpperCase()}`]=t.labData,a(i,r)}),N(t),t.labData}async function F(){if(await y()===h){return!!await async function(){try{const e=await P();if(e)try{if(await L.windows.get(e))return await L.windows.update(e,{focused:!0,state:"normal"}),setTimeout(async()=>{try{await L.windows.update(e,{focused:!0})}catch(t){}},100),!0}catch(t){return await M(),!1}return!1}catch(t){return!1}}()||(await M(),!1)}return!1}async function N(t){try{await y()===h&&E.runtime.sendMessage(t).catch(()=>{})}catch(e){}}!function(t){t.runtime.onMessage.addListener((e,r,i)=>{if("updateBadge"===e.action)!function(t,e,a){const n=t.hostedBy?t.hostedBy.toLowerCase():"",r=t.cacheStatus?t.cacheStatus.toLowerCase():"",i="bigscoots"===n,o="hit"===r;let s;s=i&&o?"#1a73e8":i?"#4CAF50":"#F44336";a.action.setBadgeText({text:"â—",tabId:e.tab.id}),a.action.setBadgeBackgroundColor({color:[0,0,0,0],tabId:e.tab.id}),a.action.setBadgeTextColor({color:s,tabId:e.tab.id})}(e,r,t);else if("analysisResults"===e.action)!function(t,e){const a=e.tab.id,r=e.tab.url,i=Date.now(),o=`lastAnalysisLog_${a}`,s=B.get(o)||0;i-s>2e3&&B.set(o,i);const c=i-36e5;for(const[n,u]of B.entries())u<c&&B.delete(n);const l={...t,url:r,timestamp:i};(0,n.storeTabResults)(a,l),N(t)}(e,r);else if("updateINP"===e.action)!function(t,e){const a=e.tab.id,r=Date.now(),i=`lastINPLog_${a}`,o=B.get(i)||0;r-o>3e3&&B.set(i,r);const s=(0,n.getTabResults)(a)||{};s.inp={value:t.value,entries:t.entries,rating:t.rating,status:t.status},(0,n.storeTabResults)(a,s),N(t)}(e,r);else if("storePSIResults"===e.action)!function(t,e){const n=e.tab.id,r=e.tab.url;const i={...t.psiData,url:r,timestamp:Date.now(),completeData:t.psiData};Promise.resolve().then(a.bind(a,662)).then(({storePSIResults:t})=>{t(n,i)}),N({...t,psiData:i})}(e,r);else{if("getPSIResults"===e.action)return function(t,e){Promise.resolve().then(a.bind(a,662)).then(({getPSIResults:a})=>{const n=a(t.tabId);e(n)})}(e,i),!0;if("updatePSICLS"===e.action)_(e,r,"cls");else if("updatePSILCP"===e.action)_(e,r,"lcp");else if("updatePSIINP"===e.action)_(e,r,"inp");else if("updatePSITTFB"===e.action)_(e,r,"ttfb");else if("updatePSILabCLS"===e.action)x(e,r,"cls");else if("updatePSILabLCP"===e.action)x(e,r,"lcp");else if("updatePSIStatus"===e.action)!function(t,e){var a;null===(a=e.tab)||void 0===a||a.id,"loading"===t.status||"success"===t.status||t.status;N(t)}(e,r);else{if("getAnalysisResults"===e.action)return function(t,e){const a=(0,n.getTabResults)(t.tabId);e(a)}(e,i),!0;if("updateParameters"===e.action)return function(t,e,a){t.tabId?a.tabs.get(t.tabId,n=>{if(a.runtime.lastError||!n)return void e({urlChanged:!1,error:"Tab not found"});let r=!1;r=t.add?c(n.id,t.parameter):l(n.id,t.parameter),r&&u(n.id,a),e({urlChanged:r})}):a.tabs.query({active:!0,currentWindow:!0},n=>{if(a.runtime.lastError||!n||0===n.length)return void e({urlChanged:!1,error:"No active tab found"});const r=n[0];let i=!1;i=t.add?c(r.id,t.parameter):l(r.id,t.parameter),i&&u(r.id,a),e({urlChanged:i})})}(e,i,t),!0;if("getParameters"===e.action)return function(t,e){const a=arguments[2];if(a&&a.tabId){const e=s(a.tabId);return void t(Array.from(e))}e.tabs.query({active:!0,currentWindow:!0},a=>{if(e.runtime.lastError||!a||0===a.length)return void t([]);const n=s(a[0].id);t(Array.from(n))})}(i,t,e),!0;if("detachPopup"===e.action)return async function(t,e){try{const a=await new Promise(t=>{e.tabs.query({active:!0,currentWindow:!0},a=>{e.runtime.lastError?t([]):t(a||[])})}),n=a.length>0?a[0].id:null;t({success:!0,windowId:(await T(n)).id,originalTabId:n})}catch(a){t({success:!1,error:a.message})}}(i,t),!0;if("attachPopup"===e.action)return async function(t){try{await async function(){const t=await P();if(t)try{await C(t),await L.windows.remove(t)}catch(e){}await M()}(),t({success:!0})}catch(e){t({success:!1,error:e.message})}}(i),!0;if("getWindowState"===e.action)return async function(t){try{t({state:await async function(){return await y()}()})}catch(e){t({state:"attached",error:e.message})}}(i),!0;if("tabUrlChanged"===e.action)return function(t,e){N({action:"tabUrlChanged",tabId:t.tabId,url:t.url}),e&&e({success:!0})}(e,i),!0;if("getTabUrl"===e.action)return function(t,e){if(!t.tabId)return void e({success:!1,error:"No tab ID provided"});E.tabs.get(t.tabId,t=>{E.runtime.lastError?e({success:!1,error:E.runtime.lastError.message}):e(t?{success:!0,url:t.url,tab:t}:{success:!1,error:"Tab not found"})})}(e,i),!0;"completePSIResults"===e.action&&function(t,e){var n;const r=null===(n=e.tab)||void 0===n?void 0:n.id;r&&t.psiData&&Promise.resolve().then(a.bind(a,662)).then(({getPSIResults:e,storePSIResults:a})=>{const n=e(r)||{allFieldData:{},allLabData:{}};n.completeData=t.psiData,n.timestamp=Date.now(),a(r,n)});N(t)}(e,r)}}return!0}),t.tabs.onUpdated.addListener((e,n,r)=>{n.url&&(Promise.resolve().then(a.bind(a,662)).then(({getTabResults:t,getPSIResults:a,storeTabResults:r,storePSIResults:i})=>{const o=t(e),s=a(e);if(o&&o.url)try{const t=new URL(o.url).hostname;t!==new URL(n.url).hostname&&(r(e,null),i(e,null))}catch(c){}if(s&&s.url)try{const t=new URL(s.url).hostname;t!==new URL(n.url).hostname&&i(e,null)}catch(c){}}),t.runtime.sendMessage({action:"tabUrlChanged",tabId:e,url:n.url}).catch(()=>{}))})}(chrome),chrome.action.onClicked.addListener(async t=>{await F()}),chrome.tabs.onRemoved.addListener(t=>{(0,n.cleanupTab)(t),function(t){r.delete(t)}(t)}),chrome.webNavigation.onBeforeNavigate.addListener(t=>{if(0===t.frameId)try{const e=s(t.tabId);if(e&&e.size>0){const a=o(t.url),n=new Set([...a,...e]);if(n.size>a.size){const e=i(t.url,n);e!==t.url&&chrome.tabs.update(t.tabId,{url:e})}}}catch(e){}}),chrome.windows.onRemoved.addListener(async t=>{await U(t)&&await M()}),chrome.windows.onBoundsChanged.addListener(async t=>{await U(t.id)&&await C(t.id)})})();
//# sourceMappingURL=background.js.map